apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: vcluster-provisioner
  namespace: argocd
spec:
  generators:
    - git:
        repoURL: https://github.com/bahram663/vcluster-deploy.git
        revision: main
        branches:
          - "feature-*"
          - "dev"
          - "test"
  template:
    metadata:
      name: "{{branch}}-vcluster"
    spec:
      project: default
      source:
        repoURL: https://charts.loft.sh
        chart: vcluster
        targetRevision: 0.20.0
        helm:
          releaseName: "{{branch}}"
          values: |
            expose:
              type: LoadBalancer
            syncer:
              extraArgs:
                - --tls-san={{branch}}.vcluster.test.bahram.az
            ingress:
              enabled: true
              host: "{{branch}}.vcluster.test.bahram.az"
      destination:
        server: https://kubernetes.default.svc
        namespace: "{{branch}}-vcluster"
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
